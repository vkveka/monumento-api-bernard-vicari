<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Monumento</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    <h2>Chat Monumento</h2>

    <label>
        Role:
        <select id="role">
            <option value="user">Utilisateur</option>
            <option value="guide">Guide</option>
        </select>
    </label>

    <input id="nom" type="text" placeholder="Nom">

    <button onclick="join() ">Rejoindre le chat</button>

    <div id="chatZone" style="display: none">
        <h3>Messages</h3>
        <ul id="chat"></ul>

        <input type="text" id="msg" placeholder="Ecris ton message">
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <script>
        const socket = io('http://localhost:3000', {
            auth: {
                token: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJOYW1lIjoiYWRtaW4iLCJpYXQiOjE3NTgyODczNTMsImV4cCI6MTc1ODI4OTE1M30.m5sSsaFct5OjfrFWlOg4FKQYmLw42e0A8zjvo8CdxKrZqxZ-bcwJPj3SZJqb47-Y0K0VRFVu5W9LSYRrpqa7P-m4h3v2H2ZXWCvgljsZh-bmqiijv5MfeWL6RChXzcuEBU2stU6vYoxTph0pI2yWnSgxHSEAcC_nN4UnYRB9MTU4Yb2F4DLESG7zE7lkpzBH8VXkk8TKEYPAYAOK0HhZBXsblg1UBeBsHAsjfMgTntI9KAe9DZU6isuoGB-5f3JKSIM6RfaDuBJATMOPReMUTvUYmz0waGVSBkJbtlitlmZxvpnoIL62TghA9twiPnczbd61QOdsk6mm0lBcUMAFSg"
            }
        });

        let monumentId = 1
        let role, user

        function join() {
            role = document.getElementById('role').value
            user = document.getElementById('nom').value
            if (!user) {
                alert("Veuillez entrer un nom")
                return
            }
            socket.emit('joinMonument', { monumentId, role, user });
            document.getElementById('chatZone').style.display = 'block'
        }

        function sendMessage() {
            const message = document.getElementById('msg').value;
            if (message.trim() === '') return;
            socket.emit('sendMessage', { monumentId, role, message });
            document.getElementById('msg').value = '';
        }

        socket.on('newMessage', (msg) => {
            const li = document.createElement('li');
            li.textContent = `${msg.user} (${msg.role}): ${msg.message}`;
            document.getElementById('chat').appendChild(li);
        });

        socket.on("chatHistory", (history) => {
            history.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = `${msg.user} (${msg.role}): ${msg.message}`;
                document.getElementById('chat').appendChild(li);
            });
        });

        socket.on("notification", (msg) => {
            if (msg.event === "newMonument") {
                console.log("Nouveau monument publié :", msg.data);
            }
        });

        socket.on("connect_error", (err) => {
            console.error("❌ Erreur de connexion socket :", err.message);
        });
    </script>
</body>

</html>