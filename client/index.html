<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Monumento</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    <h2>Chat Monumento</h2>

    <label>
        Role:
        <select id="role">
            <option value="user">Utilisateur</option>
            <option value="guide">Guide</option>
        </select>
    </label>

    <input id="nom" type="text" placeholder="Nom">

    <button onclick="join() ">Rejoindre le chat</button>

    <div id="chatZone" style="display: none">
        <h3>Messages</h3>
        <ul id="chat"></ul>

        <input type="text" id="msg" placeholder="Ecris ton message">
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <script>
        const socket = io('http://localhost:3000', {
            auth: {
                token: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsInVzZXJOYW1lIjoiYWRtaW4iLCJpYXQiOjE3NTgyOTA1NjYsImV4cCI6MTc1ODI5MjM2Nn0.YUj-qbaacT2wFul5S8RUZZ0-F-PeVFUYpBBFv9Xb6b7XiRWhXLkF15hFLRoE9IOPhzBj7fnvn71e4v3VeWsd02zxRLXGY5LdCaoGgxaJWO33XbUzkq6iZ9ZS5i7AlfwYbo0XpUqGkBwQjgwyK7F9GQhJzR2mVTBSzp8E7Aj72lNf9T3NMs0kvqGybNMPQfrCsCkTGydLB61yfqUuJCrvSxRUeFpoOtoTfSktQ1ocL_oIKDI_qhZYeQHfKgMXK2KE-ZTYDkOPsZfs_Wd0VEvSGva5dGqF4kiWwZFq6eC8pqU6aMTlURIH-1st_njFbWEskQhDTRPRF3TiMBbJDR5jwQ"
            }
        });

        let monumentId = 1
        let role, user

        function join() {
            role = document.getElementById('role').value
            user = document.getElementById('nom').value
            if (!user) {
                alert("Veuillez entrer un nom")
                return
            }
            socket.emit('joinMonument', { monumentId, role, user });
            document.getElementById('chatZone').style.display = 'block'
        }

        function sendMessage() {
            const message = document.getElementById('msg').value;
            if (message.trim() === '') return;
            socket.emit('sendMessage', { monumentId, role, message });
            document.getElementById('msg').value = '';
        }

        socket.on('newMessage', (msg) => {
            const li = document.createElement('li');
            li.textContent = `${msg.user} (${msg.role}): ${msg.message}`;
            document.getElementById('chat').appendChild(li);
        });

        socket.on("chatHistory", (history) => {
            history.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = `${msg.user} (${msg.role}): ${msg.message}`;
                document.getElementById('chat').appendChild(li);
            });
        });

        socket.on("notification", (msg) => {
            if (msg.event === "newMonument") {
                console.log("Nouveau monument publié :", msg.data);
            }
        });

        socket.on("connect_error", (err) => {
            console.error("❌ Erreur de connexion socket :", err.message);
        });
    </script>
</body>

</html>